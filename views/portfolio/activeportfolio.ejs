<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= title %></title>
       <style>
          .select2-dropdown--below {
            z-index: 999999 !important;
            
          }
           .withdrawal-button {
    border-radius: 5px;
    border: 1px solid transparent;
    cursor: pointer;
    line-height: inherit;
    padding: 8px 16px;
    font-size: 1.1rem;
    transition: all 0.5s ease-in-out;
    background-color: #24095d;
    color: #fff;
    display: inline-block;
    font-size: 1rem;
  }
.btn-close{
  color: white!important;
  background-color: #fff !important;
}
.form-control:read-only {
  background-color: #e9ecef !important;
}
  .withdrawal-button:hover {
    background-color: #5622c5 !important;
    color: #fff !important;
    cursor: pointer;
  }
        </style>
  </head>
  <body class="hold-transition light-skin sidebar-mini theme-primary fixed">
    <div class="wrapper">
      <header class="main-header">
        <!-- header -->
        <%- include('../layouts/header') %>
      </header>
    <aside class="main-sidebar" style="border-right: 1px solid #cbcbcb">
        <!-- sidebar-->
        <%- include('../layouts/aside') %>
      </aside>

      <div
        class="content-wrapper bg-white"
        style="border-radius: 0; border-top: 1px solid #cbcbcb"
      >
        <div class="container mt-30">
          <img
            src="/images/header/active_Investment Portfolio_Web.png"
            alt="refaral"
            srcset=""
          />
          <section class="content">
            <% let activePortfolioFound = false; %> <%
            buyPortfolios.forEach(function(buyPortfolio) { %> <% if
            (buyPortfolio.status === 'active') { %> <% activePortfolioFound =
            true; %>
            <div class="active__portfolio">
              <div class="row">
                <div class="col-xl-8 col-lg-7">
                  <div class="card b-groove">
                    <div class="card-body">
                      <h3 class="text-center mb-2">
                        <%= buyPortfolio.portfolioName %>
                      </h3>
                      <p class="text-center mb-10">
                        <span
                          class="badge bg-success-light"
                        >
                          <%= buyPortfolio.status %>
                        </span>
                      </p>
                      <div class="row">
                        <div class="col-12 col-md-4 mt-20">
                          <div class="text-center">
                            <div class="">
                              <p class="fs-17">$<%= buyPortfolio.amount.toLocaleString()  %></p>
                              <p class="fw-500 fs-18">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                AMOUNT INVESTED
                              </p>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4 mt-20">
                          <div class="text-center">
                            <div class="box-body py-5">
                              <p class="fs-17"><%= buyPortfolio.payout %></p>
                              <p class="fw-500 fs-18">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                PAYOUT
                              </p>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4 mt-20">
                          <div class="text-center">
                            <div class="box-body py-5">
                              <p class="fs-17">12 months</p>
                              <p class="fw-500 fs-18">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                DURATION
                              </p>
                            </div>
                          </div>
                        </div>
                        <div class="mt-30">
                          <div class="row show-grid mb-5">
                            <div class="col-md-4"></div>
                            <div class="col-md-8">
                              <button
                                type="submit"
                                class="waves-effect waves-light btn btn-success mb-5" data-bs-toggle="modal" data-bs-target="#signup-modal"
                                style="margin-right: 30px"
                              >
                                Re-Invest
                              </button>

                              <button
                                type="button"
                                class="withdrawal-button"
                                  data-bs-toggle="modal"
                          data-bs-target="#standard-modal"
                              >
                                Make Withdrawal
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-xl-4">
                  <div class="box b-groove">
                    <h3 class="text-center">Investment Timeframe</h3>
                      <hr />
                    <div
                    class="box-body mt-0 mb-0"
                    style="padding-top: 52px; padding-bottom: 48px"
                    >
                      <div class="d-flex align-items-center mb-10">
                        <div
                          class="me-15 bg-lightest h-50 w-50 l-h-60 rounded100 text-center"
                        >
                          S
                        </div>
                        <div class="d-flex flex-column">
                          <h4 class="text-dark mb-1 fs-16">
                            Open date:
                            <span>
                              <%=
                              buyPortfolio.dateOfPurchase.toLocaleDateString('en-US',
                              { weekday: 'short', month: 'short', day:
                              'numeric', year: 'numeric' }) %>
                            </span>
                          </h4>
                        </div>
                      </div>
                      <div class="d-flex align-items-center mb-10">
                        <div
                          class="me-15 bg-lightest h-50 w-50 l-h-60 rounded100 text-center"
                        >
                          E
                        </div>
                        <div class="d-flex flex-column">
                          <h4 class="text-dark mb-1 fs-16">
                            Close date:
                            <span>
                              <%=
                              buyPortfolio.dateOfExpiry.toLocaleDateString('en-US',
                              { weekday: 'short', month: 'short', day:
                              'numeric', year: 'numeric' }) %>
                            </span>
                          </h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
  <div id="signup-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="reInvestModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
      <div class="modal-header bg-black" style="background-color: #24095d; color: #fff;">
                  <button
                
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>

      <div class="modal-body">
          <div
                  class="d-md-flex justify-content-between align-items-center mb-5"
                >
                
                    
          <div  class="col-md-6" style="border: 1px solid #cacaca;
    padding: 5px 10px 5px 10px;"> <h5>Account Balance</h5>  <h2>$<%= totalAccount ?
                              totalAccount.toLocaleString() : '0' %></h2></div>
             
                
                          
          <div  style="border: 1px solid #cacaca;
    padding: 5px 10px 5px 10px; display: none;"> <h5> Compounding Balance</h5> <h2> $<%= TotalCompoundingBalance ?
                              TotalCompoundingBalance.toLocaleString() : '0' %></h2></div>
                
                </div>
    
        <form class="" action="/portfolio/re-invest/<%= buyPortfolio._id %>" method="post">
          <div class="mt-20-3">
            <div class="mb-3">
              <label for="portfolio-type">Category</label>
              <div class="input-group mb-10">
                <input type="text" name="invested-portfolio-name" id="portfolio-type" class="form-control" value="<%= buyPortfolio.payout %>" disabled>
              </div>
            </div>
            <label for="portfolio">Investment Portfolio</label>
            <div class="input-group mb-10">
              <input type="text" name="invested-portfolio-name" id="portfolio" class="form-control" value="<%= buyPortfolio.portfolioName %>" disabled>
            </div>
          </div>
          <div class="mb-3">
            <label for="invested-amount">Amount Invested</label>
            <div class="input-group mb-10">
              <input type="text" name="invested-amount" id="invested-amount" class="form-control" value="$<%= buyPortfolio.amount %>" disabled>
            </div>
          </div>
          <div class="mb-3">
            <label for="add-availableAmount">Add Amount</label>
            <div class="input-group mb-10">
              
              <input type="text" name="availableAmount" id="amount" class="form-control" placeholder="$100" min="100">
              
              
              </div>
              <span id="amount-error" style="color:red; display:none;"></span>
              
          </div>
          <div class="mb-3">
            <label for="add-newAmount">Select payment platform</label>
            <select
                            class="form-control"
                            style="width: 100%"
                            tabindex="-1"
                            aria-hidden="true"
                            name="method"
                            id="method"
                          
                          >
                            <option value="" selected disabled>
                             Select Payment Platform
                            </option>
                            <option value="Available-Balance">Available Balance</option>
                            <option value="add-newamount">
                             Add new Amount
                            </option>
                            
                          </select>
            </div>
            <div id="payment-option" style="border: 1px solid #cacaca; padding: 5px;">

  <div class="mb-3">
            <label for="add-newAmount">Currency</label>
         <select class="form-control" id="currency-select">
  <option value="" selected disabled>Select Currency</option>
  <option value="BTC">Bitcoin</option>
  <option value="ETH">Ethereum</option>
  <option value="USDT">Tether USD TRC20</option>
</select>



             <div id="wallet-detail"></div>


              </div>
            
          </div>
         
          

           <div class="mt-10">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Close
                      </button>
                     <button id="submit-button" type="submit"  class="withdrawal-button" onclick="toggleSpinner('purchaseSpinner')">
  <span id="purchaseSpinner" class="spinner-border spinner-border-sm" style="display:none;"></span>
  Purchase
</button>


                    </div>
        </form>
      </div>
    </div>
  </div>
</div>

   <div id="standard-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="withdrawModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-black">
                  <h4 class="modal-title" id="standard-modalLabel">
                     Account Balance: 
                      $<%= totalAccount ?
                            totalAccount.toLocaleString() : '0' %>
                 </h4>
                 
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                 
                
                 
                  <form
                    class="rform__modified"
                    action="/user/withdrawal"
                    method="post"
                    onsubmit="submitForm(event)"
                  >
                    <div class="form-group">
                      <div
                        class="d-md-flex justify-content-between align-items-center"
                      >
                        <div class="col-7">
                          <input
                            type="number"
                            name="authCode"
                            class="form-control ps-15 p-10"
                            placeholder="Enter 2FA"
                            id="authCode"
                            required
                          />

                          <span
                            id="authCodeError"
                            style="color: red; display: none"
                          ></span>
                        </div>
                        <div>
                          <button
                            class="btn btn bg-gradient-info-dark" style="width: 100%;"
                            id="generateCodeBtn"
                            >
                          
<span id="authCodeSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                            Generate Code
                            </button>
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <input
                        type="number"
                        name="amount"
                        class="form-control ps-15 p-10"
                        placeholder="Min is $10"
                        id="amount"
                        min="10"
                        required
                      />
                      <span
                        id="amountError"
                        style="color: red; display: none"
                      ></span>
                    </div>
                    <div class="input-group mb-20">
                      <select
                        class="form-control select2"
                        style="width: 100%"
                        tabindex="-1"
                        aria-hidden="true"
                        name="method"
                        id="method"
                        required
                      >
                        <option value="" selected disabled>
                          Select Wallet Type
                        </option>
                        <option value="BTC" data-icon="BTC">Bitcoin</option>
                        <option value="ETH" data-icon="ETH">Ethereum</option>
                        <option value="USDT" data-icon="USDT">
                          Tether USD TRC20
                        </option>
                      </select>
                      <span
                        id="methodError"
                        style="color: red; display: none"
                      ></span>
                    </div>
                    <div class="form-group">
                      <input
                        type="text"
                        name="walletAddress"
                        class="form-control ps-15 p-10"
                        placeholder="Wallet Address"
                        id="walletAddress"
                        title="Please enter a valid wallet address"
                        required
                      />
                      <span
                        id="walletAddressError"
                        style="color: red; display: none"
                      ></span>
                    </div>

                    <hr />
                    <div class="mt-10">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Close
                      </button>
                      <button type="submit" class="btn btn bg-gradient-info-dark">
                         <span id="spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Withdraw Now
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>


            <% } %> <% }); %> <% if (!activePortfolioFound) { %>
            
            <h3>No Active portfolio found</h3>
            <% } %>
          </section>
                       


  </div>
</div>


      <footer class="main-footer bg-white">
  
        <%- include('../layouts/footer') %>
         <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
         
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>


 $(document).ready(function() {
      function validateForm() {
        const amountValue = parseFloat($('#amount').val());
        const methodValue = $('#method').val();
        const errorElement = $('#amount-error');
        const submitButton = $('#submit-button');

        let isValid = true;

        if (amountValue < 100 || isNaN(amountValue)) {
          errorElement.text('The amount must be at least $100');
          errorElement.show();
          isValid = false;
        } else {
          errorElement.hide();
        }

        if (!methodValue) {
          // You can add another error element to show a specific message for this field if you want
          isValid = false;
        }

        submitButton.prop('disabled', !isValid);
      }

      $('#amount').on('input', function() {
        // Include your existing code here if you have any.
        validateForm();
      });

      $('#method').on('change', function() {
        validateForm();
      });

      $('#your-form').on('submit', function(e) {
        if ($('#submit-button').prop('disabled')) {
          e.preventDefault();
        }
      });

      // Initial validation
      validateForm();
    });

  document
    .getElementById('generateCodeBtn')
    .addEventListener('click', function () {
      // Show the spinner for auth code
      document.getElementById('authCodeSpinner').style.display = 'inline-block';

      // Retrieve the value from the 2FA input field
      var twoFactorValue = document.getElementById('authCode').value;

      // Make a POST request to the "user/2factor" endpoint
      axios
        .post('/user/two-factor', { twoFactorValue })
        .then(function (response) {
          // Handle the response from the server
          console.log(response.data);
          // Hide the spinner for auth code
          document.getElementById('authCodeSpinner').style.display = 'none';
          // Perform any necessary actions based on the response
        })
        .catch(function (error) {
          // Handle errors
          console.error(error);
          // Hide the spinner for auth code
          document.getElementById('authCodeSpinner').style.display = 'none';
        });
    });
  


     $('form').on('submit', function (event) {
    var action = $(this).attr('action');
    
    // Only run AJAX for the withdrawal form
    if (action === '/user/withdrawal') {
      event.preventDefault();

      // Show the spinner
      $('#spinner').show();

      var formData = $(this).serialize();

      $.ajax({
        type: 'POST',
        url: action,
        data: formData,
        success: function (response) {
          // Hide the spinner
          $('#spinner').hide();
          // Handle successful response
          window.location.href = response.redirectUrl;
        },
    error: function (xhr, status, error) {
      // Hide the spinner
      $('#spinner').hide();
                // Handle error response
                var errorMessage = xhr.responseText;

                // Hide all error messages
                $('#authCodeError').hide();
                $('#amountError').hide();
                $('#methodError').hide();
                $('#walletAddressError').hide();

                switch (errorMessage) {
                  case 'Missing required information.':
                    // Show error on all fields
                    $('#authCodeError').text('Required').show();
                    $('#amountError').text('Required').show();
                    $('#methodError').text('Required').show();
                    $('#walletAddressError').text('Required').show();
                    break;
                  case 'Invalid user or authentication record.':
                    // Show error on authentication field
                    $('#authCodeError')
                      .text('Invalid user or authentication record')
                      .show();
                    break;
                  case 'Authentication code is empty.':
                    // Show error on authentication field
                    $('#authCodeError')
                      .text('Authentication code is empty')
                      .show();
                    break;
                  case 'Invalid authentication code.':
                    // Show error on authentication field
                    $('#authCodeError')
                      .text('Invalid authentication code')
                      .show();
                    break;
                  case 'Insufficient balance.':
                    // Show error on amount field
                    $('#amountError').text('Insufficient balance').show();
                    break;
                  default:
                    // Show general error
                    alert('An error occurred: ' + errorMessage);
                    break;
                }
              },
            });
          }
          });

        $(document).ready(function(){
  // Initially hide the payment-option div
  $('#payment-option').hide();

  // Show or hide 'payment-option' div based on selected payment method
  $('#method').change(function() {
    if ($(this).val() === 'add-newamount') {
      $('#payment-option').show();
      // Change the name attribute of the amount input to "new-amount"
      $('#amount').attr('name', 'newAmount');
    } else {
      $('#payment-option').hide();
      $('#wallet-detail').hide(); // Hide the wallet detail if payment option changes
      // Change the name attribute of the new-amount input back to "amount"
      $('#amount').attr('name', 'availableAmount');
    }
  });
});




  // Function to make the AJAX request
function makeAjaxRequest(selectedCurrency, amount) {
  $('#wallet-detail').html('<div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>');

  $.ajax({
    type: 'POST',
    url: '/user/get-wallet-details',
    data: {
      amount: amount
    },
  })
  .then(function(response) {
    const data = response.walletDetails;
console.log(response)
    // Clear previous wallet details
    $('#wallet-detail').empty();

    // Loop through each wallet detail to find a match
    data.forEach((detail) => {
      if (detail.name === selectedCurrency) {
        // Create a new div for this set of details
        const walletDiv = $('<div class="wallet-detail" style="text-align:center"></div>');

        // Add the QR code image
        const qrImg = $('<img width="120">').attr('src', detail.qrCode);
        walletDiv.append(qrImg);

        // Add the name of the cryptocurrency
        const cryptoName = $('<p style="text-align:center">').text(`Currency ${detail.name} Amount In crypto: ${detail.cryptoAmount}`);
  walletDiv.append(cryptoName);
        // Add the wallet address
      // Create a wrapper div with flexbox styling
const wrapperDiv = $('<div class="d-flex align-items-center">');

// Create the input field
const walletInput = $('<input class="form-control">').attr('type', 'text').val(detail.address);

// Create the copy button
const copyButton = $('<button class="btn btn-primary ml-2">').text('Copy');

// When the copy button is clicked, copy the input's value to the clipboard
copyButton.on('click', function(event) {
  // Prevent the form from being submitted
  event.preventDefault();
  
  // Copy the input's value to the clipboard
  walletInput.select();
  document.execCommand('copy');
});

// Append both the input and the button to the wrapper div
wrapperDiv.append(walletInput, copyButton);

// Append the wrapper div to the main walletDiv
walletDiv.append(wrapperDiv);

        // Append this div to the container
        $('#wallet-detail').append(walletDiv);
      }
    });
  });
}

// Listen for changes on the currency dropdown
$('#currency-select').on('change', function() {
  const selectedCurrency = $(this).val();
  const amount = $('#amount').val();

  if (!amount) {
    $('#amount').css('border', '1px solid red');
    $('#amount-error').text('Please enter amount first').show();
    return;
  } else {
    $('#amount').css('border', '1px solid green');
    $('#amount-error').hide();
    makeAjaxRequest(selectedCurrency, amount);
  }
});

// Listen for changes on the amount input field
$('#amount').on('input', function() {
  const selectedCurrency = $('#currency-select').val();
  const amount = $(this).val();

  if (amount) {
    $('#amount').css('border', '1px solid green');
    $('#amount-error').hide();
    makeAjaxRequest(selectedCurrency, amount);
  } else {
    $('#amount').css('border', '1px solid red');
    $('#amount-error').text('Please enter amount first').show();
  }
});

function toggleSpinner(id) {
  var spinner = document.getElementById(id);
  if (spinner.style.display === "none" || spinner.style.display === "") {
    spinner.style.display = "inline-block";
  } else {
    spinner.style.display = "none";
  }
}



        </script>
      </footer>

    </div>
  </body>
</html>
