<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- head and meta-->
    <title><%=title%></title>
    <%- include('layouts/head') %>
  </head>

  <body class="hold-transition light-skin sidebar-mini theme-primary fixed">
    <div class="wrapper">
      <!-- <div id="loader"></div> -->

      <header class="main-header">
        <!-- header-->
        <%- include('layouts/header') %>
      </header>

      <aside class="main-sidebar">
        <!-- sidebar-->
        <%- include('layouts/aside') %>
      </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <div class="container-full">
          <!-- Main content -->
          <section class="content">
            <div class="row">
              <div class="row">
                <div class="col-xl-3 col-lg-6 col-sm-6 col-12">
                  <div class="box mb-15 pull-up hover-success">
                    <div class="box-body">
                      <div
                        class="d-flex align-items-center justify-content-between"
                      >
                        <h4 class="fw-500">Active Portfolio</h4>
                      </div>
                      <div class="row align-items-center mt-10">
                        <div class="col-6">
                          <% let activePortfoliosCount = 0; %>
                          <!-- Initialize a variable to keep track of the count -->

                          <% portfolios.forEach(function(portfolio) { %> <% if
                          (portfolio.status === 'active') { %> <%
                          activePortfoliosCount++; %>
                          <!-- Increment the count for each active portfolio -->
                          <% } %> <% }) %>

                          <h3 class="m-0 fw-600">
                            <%= activePortfoliosCount %>
                          </h3>
                        </div>

                        <div class="col-6">
                          <div class="text-end" style="position: relative">
                            <div
                              id="new-leads-chart"
                              style="min-height: 79px"
                            ></div>
                            <div class="resize-triggers">
                              <div class="expand-trigger">
                                <div style="width: 136px; height: 71px"></div>
                              </div>
                              <div class="contract-trigger"></div>
                            </div>
                          </div>
                        </div>
                        <!-- end row-->
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-sm-6 col-12">
                  <div class="box mb-15 pull-up hover-success">
                    <div class="box-body">
                      <div
                        class="d-flex align-items-center justify-content-between"
                      >
                        <h4 class="fw-500">Compounding Dividends</h4>
                      </div>
                      <div class="row align-items-center mt-10">
                        <div class="col-6">
                          <% let totlaCompBalance = 0; %> <%
                          portfolios.forEach(function(portfolio) { %> <%
                          totlaCompBalance += portfolio.compBalance %>
                          <!-- Display the compBalance value with a unique identifier -->
                          <h1>
                            <span id="compBalance-<%- portfolio._id %>">
                              <% }) %> $ <%= totlaCompBalance.toLocaleString()
                              %></span
                            >
                          </h1>
                        </div>
                        <div class="col-6">
                          <div class="text-end" style="position: relative">
                            <div
                              id="deals-chart"
                              style="min-height: 78.95px"
                            ></div>
                            <div class="resize-triggers">
                              <div class="expand-trigger"></div>
                              <div class="contract-trigger"></div>
                            </div>
                          </div>
                        </div>
                        <!-- end row-->
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-sm-6 col-12">
                  <div class="box mb-15 pull-up hover-success">
                    <div class="box-body">
                      <div
                        class="d-flex align-items-center justify-content-between"
                      >
                        <h4 class="fw-500">Total referral commission</h4>
                      </div>
                      <div class="row align-items-center mt-10">
                        <div class="col-6">
                          <h3 class="m-0 fw-600">0</h3>
                        </div>
                        <div class="col-6">
                          <div class="text-end" style="position: relative">
                            <div id="new-leads-chart3" style="min-height: 70px">
                              <div
                                id="apexchartsd4yklzuvk"
                                class="apexcharts-canvas apexchartsd4yklzuvk apexcharts-theme-light"
                              >
                                <svg
                                  id="SvgjsSvg1437"
                                  width="100"
                                  height="70"
                                  xmlns="http://www.w3.org/2000/svg"
                                  version="1.1"
                                  xmlns:xlink="http://www.w3.org/1999/xlink"
                                  xmlns:svgjs="http://svgjs.com/svgjs"
                                  class="apexcharts-svg"
                                  xmlns:data="ApexChartsNS"
                                  transform="translate(0, 0)"
                                  style="background: transparent"
                                >
                                  <g
                                    id="SvgjsG1439"
                                    class="apexcharts-inner apexcharts-graphical"
                                    transform="translate(0, 0)"
                                  >
                                    <defs id="SvgjsDefs1438">
                                      <clipPath id="gridRectMaskd4yklzuvk">
                                        <rect
                                          id="SvgjsRect1445"
                                          width="106"
                                          height="72"
                                          x="-3"
                                          y="-1"
                                          rx="0"
                                          ry="0"
                                          opacity="1"
                                          stroke-width="0"
                                          stroke="none"
                                          stroke-dasharray="0"
                                          fill="#fff"
                                        ></rect>
                                      </clipPath>
                                      <clipPath
                                        id="forecastMaskd4yklzuvk"
                                      ></clipPath>
                                      <clipPath
                                        id="nonForecastMaskd4yklzuvk"
                                      ></clipPath>
                                      <clipPath
                                        id="gridRectMarkerMaskd4yklzuvk"
                                      >
                                        <rect
                                          id="SvgjsRect1446"
                                          width="104"
                                          height="74"
                                          x="-2"
                                          y="-2"
                                          rx="0"
                                          ry="0"
                                          opacity="1"
                                          stroke-width="0"
                                          stroke="none"
                                          stroke-dasharray="0"
                                          fill="#fff"
                                        ></rect>
                                      </clipPath>
                                    </defs>
                                    <line
                                      id="SvgjsLine1444"
                                      x1="0"
                                      y1="0"
                                      x2="0"
                                      y2="70"
                                      stroke="#b6b6b6"
                                      stroke-dasharray="3"
                                      class="apexcharts-xcrosshairs"
                                      x="0"
                                      y="0"
                                      width="1"
                                      height="70"
                                      fill="#b1b9c4"
                                      filter="none"
                                      fill-opacity="0.9"
                                      stroke-width="1"
                                    ></line>
                                    <g
                                      id="SvgjsG1452"
                                      class="apexcharts-xaxis"
                                      transform="translate(0, 0)"
                                    >
                                      <g
                                        id="SvgjsG1453"
                                        class="apexcharts-xaxis-texts-g"
                                        transform="translate(0, 2.75)"
                                      ></g>
                                    </g>
                                    <g id="SvgjsG1466" class="apexcharts-grid">
                                      <g
                                        id="SvgjsG1467"
                                        class="apexcharts-gridlines-horizontal"
                                        style="display: none"
                                      >
                                        <line
                                          id="SvgjsLine1469"
                                          x1="0"
                                          y1="0"
                                          x2="100"
                                          y2="0"
                                          stroke="#e0e0e0"
                                          stroke-dasharray="0"
                                          class="apexcharts-gridline"
                                        ></line>
                                        <line
                                          id="SvgjsLine1470"
                                          x1="0"
                                          y1="14"
                                          x2="100"
                                          y2="14"
                                          stroke="#e0e0e0"
                                          stroke-dasharray="0"
                                          class="apexcharts-gridline"
                                        ></line>
                                        <line
                                          id="SvgjsLine1471"
                                          x1="0"
                                          y1="28"
                                          x2="100"
                                          y2="28"
                                          stroke="#e0e0e0"
                                          stroke-dasharray="0"
                                          class="apexcharts-gridline"
                                        ></line>
                                        <line
                                          id="SvgjsLine1472"
                                          x1="0"
                                          y1="42"
                                          x2="100"
                                          y2="42"
                                          stroke="#e0e0e0"
                                          stroke-dasharray="0"
                                          class="apexcharts-gridline"
                                        ></line>
                                        <line
                                          id="SvgjsLine1473"
                                          x1="0"
                                          y1="56"
                                          x2="100"
                                          y2="56"
                                          stroke="#e0e0e0"
                                          stroke-dasharray="0"
                                          class="apexcharts-gridline"
                                        ></line>
                                        <line
                                          id="SvgjsLine1474"
                                          x1="0"
                                          y1="70"
                                          x2="100"
                                          y2="70"
                                          stroke="#e0e0e0"
                                          stroke-dasharray="0"
                                          class="apexcharts-gridline"
                                        ></line>
                                      </g>
                                      <g
                                        id="SvgjsG1468"
                                        class="apexcharts-gridlines-vertical"
                                        style="display: none"
                                      ></g>
                                      <line
                                        id="SvgjsLine1476"
                                        x1="0"
                                        y1="70"
                                        x2="100"
                                        y2="70"
                                        stroke="transparent"
                                        stroke-dasharray="0"
                                      ></line>
                                      <line
                                        id="SvgjsLine1475"
                                        x1="0"
                                        y1="1"
                                        x2="0"
                                        y2="70"
                                        stroke="transparent"
                                        stroke-dasharray="0"
                                      ></line>
                                    </g>
                                    <g
                                      id="SvgjsG1447"
                                      class="apexcharts-line-series apexcharts-plot-series"
                                    >
                                      <path
                                        id="SvgjsPath1451"
                                        d="M 0 52.5C 3.5 52.5 6.5 23.800000000000004 10 23.800000000000004C 13.5 23.800000000000004 16.5 41.3 20 41.3C 23.5 41.3 26.5 7.700000000000003 30 7.700000000000003C 33.5 7.700000000000003 36.5 25.9 40 25.9C 43.5 25.9 46.5 52.5 50 52.5C 53.5 52.5 56.5 39.2 60 39.2C 63.5 39.2 66.5 61.6 70 61.6C 73.5 61.6 76.5 44.8 80 44.8C 83.5 44.8 86.5 63.7 90 63.7C 93.5 63.7 96.5 32.2 100 32.2"
                                        fill="none"
                                        fill-opacity="1"
                                        stroke="rgba(81,206,138,0.85)"
                                        stroke-opacity="1"
                                        stroke-linecap="butt"
                                        stroke-width="2"
                                        stroke-dasharray="0"
                                        class="apexcharts-line"
                                        index="0"
                                        clip-path="url(#gridRectMaskd4yklzuvk)"
                                        pathTo="M 0 52.5C 3.5 52.5 6.5 23.800000000000004 10 23.800000000000004C 13.5 23.800000000000004 16.5 41.3 20 41.3C 23.5 41.3 26.5 7.700000000000003 30 7.700000000000003C 33.5 7.700000000000003 36.5 25.9 40 25.9C 43.5 25.9 46.5 52.5 50 52.5C 53.5 52.5 56.5 39.2 60 39.2C 63.5 39.2 66.5 61.6 70 61.6C 73.5 61.6 76.5 44.8 80 44.8C 83.5 44.8 86.5 63.7 90 63.7C 93.5 63.7 96.5 32.2 100 32.2"
                                        pathFrom="M -1 70L -1 70L 10 70L 20 70L 30 70L 40 70L 50 70L 60 70L 70 70L 80 70L 90 70L 100 70"
                                      ></path>
                                    </g>
                                    <g
                                      id="SvgjsG1450"
                                      class="apexcharts-datalabels"
                                      data:realIndex="0"
                                    ></g>
                                  </g>
                                  <line
                                    id="SvgjsLine1477"
                                    x1="0"
                                    y1="0"
                                    x2="100"
                                    y2="0"
                                    stroke="#b6b6b6"
                                    stroke-dasharray="0"
                                    stroke-width="1"
                                    class="apexcharts-ycrosshairs"
                                  ></line>
                                  <line
                                    id="SvgjsLine1478"
                                    x1="0"
                                    y1="0"
                                    x2="100"
                                    y2="0"
                                    stroke-dasharray="0"
                                    stroke-width="0"
                                    class="apexcharts-ycrosshairs-hidden"
                                  ></line>
                                  <g
                                    id="SvgjsG1479"
                                    class="apexcharts-yaxis-annotations"
                                  ></g>
                                  <g
                                    id="SvgjsG1480"
                                    class="apexcharts-xaxis-annotations"
                                  ></g>
                                  <g
                                    id="SvgjsG1481"
                                    class="apexcharts-point-annotations"
                                  ></g>

                                  <rect
                                    id="SvgjsRect1443"
                                    width="0"
                                    height="0"
                                    x="0"
                                    y="0"
                                    rx="0"
                                    ry="0"
                                    opacity="1"
                                    stroke-width="0"
                                    stroke="none"
                                    stroke-dasharray="0"
                                    fill="#fefefe"
                                  ></rect>
                                  <g
                                    id="SvgjsG1465"
                                    class="apexcharts-yaxis"
                                    rel="0"
                                    transform="translate(-18, 0)"
                                  ></g>
                                  <g
                                    id="SvgjsG1440"
                                    class="apexcharts-annotations"
                                  ></g>
                                </svg>
                                <div
                                  class="apexcharts-legend"
                                  style="max-height: 35px"
                                ></div>
                                <div
                                  class="apexcharts-tooltip apexcharts-theme-light"
                                >
                                  <div
                                    class="apexcharts-tooltip-series-group"
                                    style="order: 1"
                                  >
                                    <span
                                      class="apexcharts-tooltip-marker"
                                      style="
                                        background-color: rgb(81, 206, 138);
                                      "
                                    ></span>
                                    <div
                                      class="apexcharts-tooltip-text"
                                      style="
                                        font-family: Helvetica, Arial,
                                          sans-serif;
                                        font-size: 12px;
                                      "
                                    >
                                      <div class="apexcharts-tooltip-y-group">
                                        <span
                                          class="apexcharts-tooltip-text-y-label"
                                        ></span
                                        ><span
                                          class="apexcharts-tooltip-text-y-value"
                                        ></span>
                                      </div>
                                      <div
                                        class="apexcharts-tooltip-goals-group"
                                      >
                                        <span
                                          class="apexcharts-tooltip-text-goals-label"
                                        ></span
                                        ><span
                                          class="apexcharts-tooltip-text-goals-value"
                                        ></span>
                                      </div>
                                      <div class="apexcharts-tooltip-z-group">
                                        <span
                                          class="apexcharts-tooltip-text-z-label"
                                        ></span
                                        ><span
                                          class="apexcharts-tooltip-text-z-value"
                                        ></span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div
                                  class="apexcharts-yaxistooltip apexcharts-yaxistooltip-0 apexcharts-yaxistooltip-left apexcharts-theme-light"
                                >
                                  <div
                                    class="apexcharts-yaxistooltip-text"
                                  ></div>
                                </div>
                              </div>
                            </div>
                            <div class="resize-triggers">
                              <div class="expand-trigger">
                                <div style="width: 136px; height: 71px"></div>
                              </div>
                              <div class="contract-trigger"></div>
                            </div>
                          </div>
                        </div>
                        <!-- end row-->
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-sm-6 col-12">
                  <div class="box mb-15 pull-up hover-success">
                    <div class="box-body">
                      <div
                        class="d-flex align-items-center justify-content-between"
                      >
                        <h4 class="fw-500">Retirement Dividends</h4>
                      </div>
                      <div class="row align-items-center mt-10">
                        <div class="col-6">
                          <h3 class="m-0 fw-600">0</h3>
                        </div>
                        <div class="col-6">
                          <div class="text-end" style="position: relative">
                            <div
                              id="booked-revenue-chart"
                              style="min-height: 81px"
                            ></div>
                            <div class="resize-triggers">
                              <div class="expand-trigger">
                                <div style="width: 136px; height: 71px"></div>
                              </div>
                              <div class="contract-trigger"></div>
                            </div>
                          </div>
                        </div>
                        <!-- end row-->
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-xl-8 col-lg-8">
                  <!-- to add later -->
                </div>

                <div class="col-xl-4 col-lg-4">
                  <div class="box">
                    <div class="box-header with-border">
                      <h4 class="fw-500">Total Invested Amount</h4>
                    </div>
                    <div class="box-body p-0">
                      <div class="text-center">
                        <!-- dashboard.ejs -->

                        <!-- Existing HTML code -->

                        <% let totalAmount = 0; %>
                        <!-- Initialize a variable to keep track of the total amount -->

                        <% portfolios.forEach(function(portfolio) { %> <%
                        totalAmount += portfolio.amount; %>
                        <!-- Add the amount of each portfolio to the total amount -->
                        <% }) %>

                        <h1>$<%= totalAmount.toLocaleString() %></h1>

                        <hr style="margin: 2px 77px 3px 77px" />
                      </div>
                    </div>
                  </div>
                  <div class="box">
                    <div class="box-header with-border">
                      <h4 class="fw-500">Balance for withdrawal</h4>
                    </div>
                    <div class="box-body p-0">
                      <div class="text-center">
                        <% let totalBalanceForWilthwal = 0; %> <%
                        portfolios.forEach(function(portfolio) { %> <%
                        totalBalanceForWilthwal += portfolio.balance %>
                        <!-- Display the compBalance value with a unique identifier -->

                        <h1>
                          <span id="balance-<%- portfolio._id %>">
                            <% }) %> $<%=
                            totalBalanceForWilthwal.toLocaleString() %>
                          </span>
                        </h1>

                        <hr style="margin: 2px 77px 3px 77px" />

                        <div class="mt-10 mt-md-0">
                          <a
                            href="#"
                            class="waves-effect waves-light btn btn-outline btn-primary"
                            >Withdraw</a
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- THE FIRST ROW END HERE -->
          </section>
          <!-- /.content -->
        </div>
      </div>
      <!-- /.content-wrapper -->

      <footer class="main-footer">
        <!-- footer-->
        <%- include('layouts/footer') %>
      </footer>
      <!-- Side panel -->
      <!-- quick_user_toggle -->
      <div class="modal modal-right fade" id="quick_user_toggle" tabindex="-1">
        <!-- user profile -->
        <%- include('layouts/right') %>
      </div>
      <!-- /quick_user_toggle -->

      <!-- Control Sidebar -->
      <%- include('layouts/sidebar') %>
    </div>
    <%- include('layouts/script') %>
    <script>
      // Establish a WebSocket connection
      const socket = new WebSocket('ws://localhost:9500');

      // Handle WebSocket connection open event
      socket.addEventListener('open', () => {
        console.log('WebSocket connection established');
      });

      // Handle WebSocket message event
      socket.addEventListener('message', event => {
        const { portfolioId, balance, compBalance } = JSON.parse(event.data);
        // Update the corresponding balance element on the page
        const balanceElement = document.getElementById(
          `balance-${portfolioId}`
        );
        const compBalanceElement = document.getElementById(
          `compBalance-${portfolioId}`
        );
        if (balanceElement) {
          balanceElement.textContent = balance;
        }
        if (compBalanceElement) {
          compBalanceElement.textContent = compBalance;
        }
      });

      // Handle WebSocket connection close event
      socket.addEventListener('close', () => {
        console.log('WebSocket connection closed');
      });

      // Handle WebSocket connection error event
      socket.addEventListener('error', error => {
        console.error('WebSocket connection error:', error);
      });
    </script>
  </body>
</html>
